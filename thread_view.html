<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewing Thread - The Attic</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .thread-container { padding: 20px; margin: 20px; background-color: #fff; border-radius: 8px; }
        #post-list { margin-bottom: 30px; }
        .post-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            overflow: hidden; 
        }
        .post-header {
            background-color: #f0f8f0; 
            padding: 10px 15px;
            border-bottom: 1px solid #d4e9d4;
            font-size: 0.9em;
            color: #556b2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .post-header strong { font-weight: 600; }
        .post-meta { display: flex; align-items: center; }
        .post-actions-container { display: flex; align-items: center; }
        
        .button-small {
            padding: 3px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            margin-left: 10px;
        }
        .button-danger {
            background-color: #dc3545;
            color: white;
        }
        .button-danger:hover {
            background-color: #c82333;
        }

        .post-content { padding: 15px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        #reply-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #8fbc8f; }
        #reply-section label { display: block; margin-bottom: 5px; font-weight: bold; }
        #reply-section textarea {
            width: 95%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 1em;
            resize: vertical;
        }
        #reply-status-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            display: none;
            font-weight: bold;
        }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-processing { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src="firebaseconfig.js"></script>
 
</head>

<body>
    <header>
        <h1 id="thread-title-h1">Loading Thread...</h1>
         <p><a id="backToForumLink" href="forums.html">Back to Forum List</a></p>
    </header>

    <main>
        <div class="thread-container">
            <div id="post-list">
                <p>Loading posts...</p>
            </div>

            <div id="reply-section" style="display: none;"> <h3>Post a Reply</h3>
                <form id="replyForm">
                    <div class="form-group">
                        <label for="replyContent">Your Reply:</label>
                        <textarea id="replyContent" name="replyContent" required minlength="5"></textarea>
                    </div>
                    <button type="submit" id="submitReplyButton" class="button">Submit Reply</button>
                    <div id="reply-status-message"></div>
                </form>
            </div>
             <div id="login-prompt" style="display: block; text-align:center; margin-top: 20px;">
                 <p><a href="login.html">Log in</a> to reply.</p>
            </div>
        </div>
    </main>

    <div id="flagPostModal" style="display:none; position:fixed; z-index:1050; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4);">
      <div style="background-color:#fefefe; margin:10% auto; padding:20px; border:1px solid #888; width:90%; max-width:550px; border-radius:8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);">
        <span id="closeFlagPostModal" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
        <h4>Flag Post for Review</h4>
        <p>You are about to flag this post. Please provide a brief reason if you wish. Your report will be sent to administrators.</p>
        <input type="hidden" id="postIdToFlag"> <input type="hidden" id="postAuthorIdToFlag"> <div class="form-group">
          <label for="flagReason">Reason (optional):</label>
          <textarea id="flagReason" name="flagReason" style="width:95%; min-height:80px; padding:8px; border:1px solid #ccc; border-radius:4px; resize:vertical;"></textarea>
        </div>
        <div id="flag-status-message" style="margin-top:10px; padding:8px; border-radius:5px; display:none; font-weight:bold;"></div>
        <button id="submitFlagButton" type="button" style="background-color:#dc3545; color:white; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">Submit Flag</button>
        <button id="cancelFlagButton" type="button" style="background-color:#6c757d; color:white; padding:10px 15px; border:none; border-radius:5px; cursor:pointer;">Cancel</button>
      </div>
    </div>

    <footer>
        <p>&copy; 2025 The Attic - Alternative Academy</p>
    </footer>

   <script>
    // --- Get Element References ---
    const threadTitleH1 = document.getElementById('thread-title-h1');
    const postListDiv = document.getElementById('post-list');
    const replySectionDiv = document.getElementById('reply-section');
    const replyStatusMessageDiv = document.getElementById('reply-status-message');
    const loginPromptDiv = document.getElementById('login-prompt');
    const backToForumLink = document.getElementById('backToForumLink');

    // References for Flag Modal
    const flagPostModalEl = document.getElementById('flagPostModal');
    const closeFlagPostModalSpan = document.getElementById('closeFlagPostModal');
    const cancelFlagButton = document.getElementById('cancelFlagButton');
    const submitFlagButton = document.getElementById('submitFlagButton');
    const flagReasonInput = document.getElementById('flagReason');
    const postIdToFlagInput = document.getElementById('postIdToFlag');
    const postAuthorIdToFlagInput = document.getElementById('postAuthorIdToFlag');
    const flagStatusMessageDiv = document.getElementById('flag-status-message');


    // --- Global Variables ---
    let currentUser = null;
    let currentThreadId = null;
    let currentForumId = null;
    let currentThreadTitle = "this thread";
    let currentUserProfile = null;
    let isAdmin = false;

    // --- Utility Functions ---
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function showReplyStatus(message, type = 'error') {
        if (replyStatusMessageDiv) {
            replyStatusMessageDiv.textContent = message;
            replyStatusMessageDiv.className = `status-${type}`;
            replyStatusMessageDiv.style.display = 'block';
            if (type === 'success' || type === 'processing') {
                setTimeout(() => {
                    if (replyStatusMessageDiv.textContent === message) {
                         replyStatusMessageDiv.style.display = 'none';
                    }
                }, 4000);
            }
        }
    }

    function showFlagStatus(message, type = 'error') {
        if (flagStatusMessageDiv) {
            flagStatusMessageDiv.textContent = message;
            flagStatusMessageDiv.className = `status-${type}`;
            flagStatusMessageDiv.style.display = 'block';
             if (type === 'success' || type === 'processing') {
                setTimeout(() => {
                    if (flagStatusMessageDiv.textContent === message) {
                        flagStatusMessageDiv.style.display = 'none';
                    }
                }, 4000);
            }
        }
    }

    function openFlagPostModal(postId, postAuthorId) {
        if (!currentUser) {
            alert("Please log in to flag a post.");
            return;
        }
        if (flagPostModalEl) {
            postIdToFlagInput.value = postId;
            postAuthorIdToFlagInput.value = postAuthorId;
            flagReasonInput.value = '';
            flagStatusMessageDiv.style.display = 'none';
            flagPostModalEl.style.display = 'block';
        }
    }

    function closeFlagPostModal() {
        if (flagPostModalEl) flagPostModalEl.style.display = 'none';
    }

    // --- Core Page Logic ---
    function getIdsFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        currentThreadId = urlParams.get('id');
        currentForumId = urlParams.get('forumId');
        return currentThreadId && currentForumId;
    }

    function fetchThreadTitle(db) {
        if (!currentThreadId || !currentForumId || !db) {
            if(threadTitleH1) threadTitleH1.textContent = "Error: Thread not found";
            return;
        }
        const threadTitleRef = db.ref(`forumData/threads/${currentForumId}/${currentThreadId}/title`);
        threadTitleRef.once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    currentThreadTitle = snapshot.val();
                    if (threadTitleH1) threadTitleH1.textContent = currentThreadTitle;
                    document.title = `${currentThreadTitle} - The Attic`;
                } else {
                    if(threadTitleH1) threadTitleH1.textContent = "Thread Not Found";
                }
            });

        if (backToForumLink && currentForumId) {
            backToForumLink.href = `forum_view.html?id=${currentForumId}`;
        } else if (backToForumLink) {
            backToForumLink.href = 'forums.html';
        }
    }

    function listenForPosts(db) {
        if (!currentThreadId || !db) return;
        const postsRef = db.ref(`forumData/posts/${currentThreadId}`).orderByChild('createdAt');
        let initialLoad = true;

        if (postListDiv && postListDiv.innerHTML.includes("Loading posts...")) {
             postListDiv.innerHTML = ''; 
        }

        postsRef.on('child_added', (snapshot) => {
            if (!postListDiv) return;
            // Clear "no posts" message if it exists
            if (postListDiv.innerHTML.includes("This thread has no posts yet")) {
                 postListDiv.innerHTML = ''; 
            }
            initialLoad = false;
            const postId = snapshot.key;
            const postData = snapshot.val();
            if (!postData) return;
            displayPost(postId, postData);
        });

        postsRef.once('value', snapshot => {
             if (!postListDiv) return;
             if (!snapshot.exists() && initialLoad) {
                 postListDiv.innerHTML = '<p>This thread has no posts yet. Be the first to reply!</p>';
                 initialLoad = false;
             }
        });
    }

    function displayPost(postId, postData) {
        if (!postListDiv) return;

        const postDiv = document.createElement('div');
        postDiv.className = 'post-item';
        postDiv.id = `post-${postId}`;

        const headerDiv = document.createElement('div');
        headerDiv.className = 'post-header';

        const postMetaDiv = document.createElement('div');
        postMetaDiv.className = 'post-meta';
        const authorSpan = document.createElement('span');
        authorSpan.innerHTML = `Posted by: <strong>${escapeHtml(postData.authorName || 'Unknown User')}</strong>`;
        const dateSpan = document.createElement('span');
        dateSpan.style.marginLeft = '10px';
        dateSpan.style.fontSize = '0.9em';
        dateSpan.textContent = postData.createdAt ? new Date(postData.createdAt).toLocaleString() : 'Unknown Time';
        postMetaDiv.appendChild(authorSpan);
        postMetaDiv.appendChild(dateSpan);
        headerDiv.appendChild(postMetaDiv);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'post-actions-container';

        // FLAG ACTION (Logged in users)
        if (currentUser) {
            const flagButton = document.createElement('span');
            flagButton.innerHTML = 'ðŸš©'; 
            flagButton.title = 'Flag this post';
            flagButton.style.cursor = 'pointer';
            flagButton.style.marginLeft = '15px';
            flagButton.onclick = function() { openFlagPostModal(postId, postData.authorUid); };
            actionsDiv.appendChild(flagButton);
        }

        // DELETE ACTION (Admin OR Author)
        // 1. Am I the author?
        const isAuthor = currentUser && postData.authorUid === currentUser.uid;
        
        if (isAdmin || isAuthor) {
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'button-small button-danger';
            deleteButton.onclick = function() {
                deletePost(currentForumId, currentThreadId, postId, postData.authorUid);
            };
            actionsDiv.appendChild(deleteButton);
        }

        headerDiv.appendChild(actionsDiv);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'post-content';
        contentDiv.innerHTML = escapeHtml(String(postData.content || '')).replace(/\n/g, '<br>');

        postDiv.appendChild(headerDiv);
        postDiv.appendChild(contentDiv);
        postListDiv.appendChild(postDiv);
    }

    function checkAuthentication(db) {
        if (!firebase?.auth || !db) {
            if (loginPromptDiv) loginPromptDiv.style.display = 'block';
            if (getIdsFromUrl()) listenForPosts(db);
            return;
        }

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const profileRef = db.ref(`users/${currentUser.uid}/profile`);
                profileRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        currentUserProfile = snapshot.val();
                        // ROBUST ADMIN CHECK
                        const role = (currentUserProfile.role || '').toLowerCase();
                        isAdmin = (role === 'admin');
                    } else {
                        isAdmin = false;
                    }
                    if (getIdsFromUrl()) listenForPosts(db);
                });

                if (replySectionDiv) replySectionDiv.style.display = 'block';
                if (loginPromptDiv) loginPromptDiv.style.display = 'none';
                
                // Attach submit listener securely
                const form = document.getElementById('replyForm');
                if (form) {
                    const newForm = form.cloneNode(true);
                    form.parentNode.replaceChild(newForm, form);
                    newForm.addEventListener('submit', (e) => handleReplySubmit(e, db));
                }

            } else { // Not logged in
                currentUser = null;
                isAdmin = false;
                if (replySectionDiv) replySectionDiv.style.display = 'none';
                if (loginPromptDiv) loginPromptDiv.style.display = 'block';
                if (getIdsFromUrl()) listenForPosts(db);
            }
        });
    }

    function handleReplySubmit(event, db) {
        event.preventDefault();
        const replyContentInput = document.getElementById('replyContent');
        const submitBtn = document.getElementById('submitReplyButton');
        const replyContent = replyContentInput.value.trim();

        if (!replyContent || replyContent.length < 5) {
            showReplyStatus('Reply must be at least 5 characters long.', 'error');
            return;
        }

        if(submitBtn) submitBtn.disabled = true;
        showReplyStatus('Posting reply...', 'processing');

        const timestamp = firebase.database.ServerValue.TIMESTAMP;
        const authorName = (currentUserProfile && currentUserProfile.atticNickname) || currentUser.displayName || currentUser.email || 'Anonymous';
        const newPostRef = db.ref(`forumData/posts/${currentThreadId}`).push();
        const newPostId = newPostRef.key;

        const postData = {
            authorUid: currentUser.uid,
            authorName: authorName,
            content: replyContent,
            createdAt: timestamp
        };

        const updates = {};
        updates[`/forumData/posts/${currentThreadId}/${newPostId}`] = postData;
        updates[`/forumData/threads/${currentForumId}/${currentThreadId}/postCount`] = firebase.database.ServerValue.increment(1);
        updates[`/forumData/threads/${currentForumId}/${currentThreadId}/lastPostInfo`] = {
            postId: newPostId,
            authorUid: currentUser.uid,
            authorName: authorName,
            timestamp: timestamp
        };
        updates[`/forumData/forums/${currentForumId}/postCount`] = firebase.database.ServerValue.increment(1);

        // Also update the forum-level lastPostInfo
        db.ref(`forumData/threads/${currentForumId}/${currentThreadId}/title`).once('value').then(snap => {
            const tTitle = snap.val() || currentThreadTitle;
            updates[`/forumData/forums/${currentForumId}/lastPostInfo`] = {
                threadId: currentThreadId,
                threadTitle: tTitle,
                postId: newPostId,
                authorUid: currentUser.uid,
                authorName: authorName,
                timestamp: timestamp
            };
            return db.ref().update(updates);
        })
        .then(() => {
            replyContentInput.value = '';
            showReplyStatus('Reply posted!', 'success');
            if(submitBtn) submitBtn.disabled = false;
        })
        .catch((error) => {
            showReplyStatus(`Error: ${error.message}`, 'error');
            if(submitBtn) submitBtn.disabled = false;
        });
    }

    // --- REVISED DELETE POST FUNCTION ---
    function deletePost(forumId, threadId, postId, postAuthorUid) {
        // 1. Permission Check
        const isAuthor = currentUser && currentUser.uid === postAuthorUid;
        
        if (!isAdmin && !isAuthor) {
            alert("You do not have permission to delete this post.");
            return;
        }

        if (!confirm("Permanently delete this post?")) return;

        const db = firebase.database();
        const postRef = db.ref(`forumData/posts/${threadId}/${postId}`);
        const threadMetaRef = db.ref(`forumData/threads/${forumId}/${threadId}`);
        const forumMetaRef = db.ref(`forumData/forums/${forumId}`);

        postRef.remove()
            .then(() => {
                // Decrement counts. (Note: Updating lastPostInfo cleanly on delete is complex, skipping for simplicity)
                const threadTx = threadMetaRef.transaction(d => {
                    if (d) d.postCount = Math.max(0, (d.postCount || 0) - 1);
                    return d;
                });
                const forumTx = forumMetaRef.transaction(d => {
                    if (d) d.postCount = Math.max(0, (d.postCount || 0) - 1);
                    return d;
                });
                return Promise.all([threadTx, forumTx]);
            })
            .then(() => {
                const el = document.getElementById(`post-${postId}`);
                if (el) el.remove();
                alert("Post deleted.");
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
    }

    function submitPostFlag() {
        if (!currentUser) return;
        const postId = postIdToFlagInput.value;
        const postAuthorUid = postAuthorIdToFlagInput.value;
        const reason = flagReasonInput.value.trim();

        if(submitFlagButton) submitFlagButton.disabled = true;
        showFlagStatus("Submitting flag...", "processing");

        const reportData = {
            reportedContentId: postId,
            contentType: "forum_post",
            reportedUserId: postAuthorUid,
            reporterUserId: currentUser.uid,
            reason: reason || "No reason provided.",
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            status: "pending_review"
        };

        firebase.database().ref('reports').push(reportData)
            .then(() => {
                showFlagStatus("Flagged successfully.", "success");
                setTimeout(() => { closeFlagPostModal(); if(submitFlagButton) submitFlagButton.disabled=false; }, 2000);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Modal listeners
        if (closeFlagPostModalSpan) closeFlagPostModalSpan.onclick = closeFlagPostModal;
        if (cancelFlagButton) cancelFlagButton.onclick = closeFlagPostModal;
        if (submitFlagButton) submitFlagButton.onclick = submitPostFlag;
        
        if (firebase && firebase.database && firebase.auth) {
            const db = firebase.database();
            if (getIdsFromUrl()) {
                fetchThreadTitle(db);
                checkAuthentication(db);
            }
        }
    });
</script>

</body>
</html>